name: owlcms-tracker
run-name: owlcms-tracker - ${{ github.event.inputs.revision }}

on:
  workflow_dispatch:
    inputs:
      revision:
        description: 'semver number for the release'
        required: true
        default: '2.3.3'

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      REVISION: ${{ github.event.inputs.revision }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Fail if tag or release already exists
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          echo "Checking if tag/release already exists for: ${REVISION}"

          if git ls-remote --tags origin "refs/tags/${REVISION}" | grep -q .; then
            echo "‚ùå Git tag already exists on origin: ${REVISION}"
            echo "Stop: choose a new version or delete the tag/release manually (not recommended)."
            exit 1
          fi

          if gh release view "${REVISION}" >/dev/null 2>&1; then
            echo "‚ùå GitHub Release already exists: ${REVISION}"
            echo "Stop: choose a new version or manually manage the existing release assets."
            exit 1
          fi
          echo "‚úì Tag and release do not exist yet"
      
      - name: Verify Docker Credentials
        run: |
          if [ -z "${{ secrets.DOCKER_USER }}" ]; then
            echo "‚ùå DOCKER_USER not found in repository secrets"
            exit 1
          fi
          if [ -z "${{ secrets.DOCKER_TOKEN }}" ]; then
            echo "‚ùå DOCKER_TOKEN not found in repository secrets"
            exit 1
          fi
          echo "‚úÖ Repository secrets retrieved successfully"
          echo "Docker Registry: ${{ vars.DOCKER_REG }}"
          echo "Docker Username: ${{ secrets.DOCKER_USER }}"
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      
      - name: Install dependencies
        run: |
          echo "Installing dependencies from package-lock.json..."
          npm ci
          echo "‚úì Dependencies installed"
          
          # Verify tracker-core version
          echo ""
          echo "üìã Checking @owlcms/tracker-core version:"
          npm list @owlcms/tracker-core || true

      
      - name: Prepare standard plugins only (matching Docker)
        run: |
          echo "Removing all plugins except standard ones..."
          rm -rf src/plugins/*
          git checkout src/plugins/attempt-board
          git checkout src/plugins/lifting-order
          git checkout src/plugins/rankings
          git checkout src/plugins/start-order
          git checkout src/plugins/team-scoreboard
          echo "‚úì Standard plugins restored"
          ls -la src/plugins/
      
      - name: Build base application
        run: npm run build
        env:
          NODE_OPTIONS: "--max-old-space-size=4096"
      
      - name: Remove pre-compressed files (server-side only)
        run: |
          find build/client -name '*.gz' -delete
          find build/client -name '*.br' -delete
          echo "‚úì Removed .gz and .br files from build"
      
      - name: Build Windows package
        run: node scripts/build-windows.js
      
      - name: Build macOS ARM64 (M-series) package
        run: node scripts/build-macos.js
      
      - name: Build macOS x64 (Intel) package
        run: MACOS_ARCH=x64 node scripts/build-macos.js
      
      - name: Build Raspberry Pi package
        run: node scripts/build-rpi.js
      
      - name: Setup Docker buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to Docker Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ vars.DOCKER_REG }}
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_TOKEN }}
      
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ vars.DOCKER_REG }}/owlcms/tracker:${{ env.REVISION }}
            ${{ vars.DOCKER_REG }}/owlcms/tracker:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: List generated packages
        run: |
          echo "Generated packages:"
          ls -lh dist/*.zip
          # Rename packages to include version
          mv dist/owlcms-tracker-windows.zip dist/owlcms-tracker-windows_${{ env.REVISION }}.zip
          mv dist/owlcms-tracker-macos.zip dist/owlcms-tracker-macos-arm64_${{ env.REVISION }}.zip
          mv dist/owlcms-tracker-macos-x64.zip dist/owlcms-tracker-macos-x64_${{ env.REVISION }}.zip
          if [ -f dist/owlcms-tracker-rpi.zip ]; then
            mv dist/owlcms-tracker-rpi.zip dist/owlcms-tracker-rpi_${{ env.REVISION }}.zip
          else
            echo "‚ö†Ô∏è  RPi package not found - build may have failed"
          fi
          echo "Renamed packages:"
          ls -lh dist/*.zip
      
      - name: Upload Windows package
        uses: actions/upload-artifact@v4
        with:
          name: owlcms-tracker-windows
          path: dist/owlcms-tracker-windows_${{ env.REVISION }}.zip
          retention-days: 90
      
      - name: Upload macOS ARM64 package
        uses: actions/upload-artifact@v4
        with:
          name: owlcms-tracker-macos-arm64
          path: dist/owlcms-tracker-macos-arm64_${{ env.REVISION }}.zip
          retention-days: 90
      
      - name: Upload macOS x64 package
        uses: actions/upload-artifact@v4
        with:
          name: owlcms-tracker-macos-x64
          path: dist/owlcms-tracker-macos-x64_${{ env.REVISION }}.zip
          retention-days: 90
      
      - name: Upload Raspberry Pi package
        if: hashFiles('dist/owlcms-tracker-rpi_*.zip') != ''
        uses: actions/upload-artifact@v4
        with:
          name: owlcms-tracker-rpi
          path: dist/owlcms-tracker-rpi_${{ env.REVISION }}.zip
          retention-days: 90
      
      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -x
          # Re-check just before tagging/releasing (race condition safety)
          if git ls-remote --tags origin "refs/tags/${{ env.REVISION }}" | grep -q .; then
            echo "‚ùå Git tag already exists on origin: ${{ env.REVISION }}"
            exit 1
          fi
          if gh release view "${{ env.REVISION }}" >/dev/null 2>&1; then
            echo "‚ùå GitHub Release already exists: ${{ env.REVISION }}"
            exit 1
          fi

          # Tag the current commit
          git config user.email "${{ github.actor }}@users.noreply.github.com"
          git config user.name "${{ github.actor }}"
          git tag ${{ env.REVISION }}
          git push origin ${{ env.REVISION }}
          
          # Create release with all packages and release notes
          gh release create ${{ env.REVISION }} \
            --title "${{ env.REVISION }}" \
            --notes-file ReleaseNotes.md \
            dist/owlcms-tracker-windows_${{ env.REVISION }}.zip \
            dist/owlcms-tracker-macos-arm64_${{ env.REVISION }}.zip \
            dist/owlcms-tracker-macos-x64_${{ env.REVISION }}.zip \
            dist/owlcms-tracker-rpi_${{ env.REVISION }}.zip
          set +x
